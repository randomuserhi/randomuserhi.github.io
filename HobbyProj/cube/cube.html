<!DOCTYPE html>
<html lang="en">
	<head>
		<title>three.js webgl - geometry - cube</title>
		<meta charset="utf-8">
		<meta id="screen" name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<style>
			body {
				margin: 0px;
				background-color: #000000;
				overflow: hidden;
			}
		</style>
	</head>
	
	<canvas id="main_window" style="position:fixed; top:0%; left:0%; height:100%; width:100%;"></canvas>
	
	<body>

		<script src="three.min.js"></script>
		<script src="GameObjects/ObjectListing.js"></script>
		<script src="GameObjects/Player.js"></script>
		<script src="GameObjects/Blocks.js"></script>
		<script src="GameObjects/SmallBlock.js"></script>
		<script src="GameObjects/Bullets.js"></script>
		<script src="GameObjects/Floor.js"></script>
		<script src="GameObjects/Drones.js"></script>
		<script src="keyboard.js"></script>
		<script src="jquery.min.js"></script>
		<script src="PhysicsEngine.js"></script>
		<script src="Generator/ObjectGenerator.js"></script>
		
		<script>
			var scene, renderer, Settings;
			var ScreenX = window.screenX;
			var ScreenY = window.screenY;
			var Player;
			var Blocks = [];
			var SmallBlocks = [];
			var Bullets = [];
			var Floor = [];
			var Drones = [];
			var numDrones = 10;
			var Seed = "-479|4924|86Z-314|3088|522Z-186|1322|737Z-50|4198|369Z-94|4929|491Z270|1115|501Z86|3643|232Z-24|2312|132Z-342|3526|793Z427|3280|766Z-252|2182|587Z-248|5982|84Z167|3208|672Z-17|2767|231Z166|7886|464Z468|7204|54Z-133|3877|659Z356|-54|287Z363|1645|227Z-11|2987|220Z252|7229|288Z194|5511|290Z1|6196|535Z-175|7312|727Z-166|-293|122Z-226|-163|1Z465|3558|543Z421|6018|441Z175|73|195Z-267|2510|108Z-482|2091|100Z120|3557|332Z-268|7725|675Z-181|2200|612Z-153|-238|92Z-30|3110|421Z476|4774|2Z-320|4356|762Z133|6677|744Z0|7537|129Z485|2228|651Z26|3110|482Z-465|1271|456Z86|4920|387Z-450|2136|386Z273|1357|18Z-372|3602|525Z-425|499|314Z357|5210|110Z310|1129|250Z-93|2559|588Z-371|1284|112Z-57|1880|182Z-55|4117|144Z-218|-407|539Z48|1900|492Z-405|6366|569Z-58|5394|363Z-430|4407|5Z-328|3849|622Z-220|3212|85Z-43|2324|84Z-287|5865|222Z304|591|429Z162|3173|765Z127|7831|654Z148|4132|706Z-441|1042|339Z-200|5984|163Z-225|3783|183Z-324|2170|472Z328|881|651Z308|2302|360Z-465|6970|124Z-42|1061|173Z173|4284|16Z-76|2880|665Z370|57|392Z149|5477|759Z-48|2883|404Z441|3794|382Z274|6456|367Z-188|5100|740Z238|4873|201Z353|582|308Z-490|2947|74Z-58|1484|212Z-178|7254|317Z98|4443|671Z-6|6484|299Z240|7830|354Z-186|2054|703Z-45|4077|399Z-377|7002|195Z-36|-5|404Z305|5241|161Z308|-62|119Z-13|4117|575Z-228|3963|301Z41|6416|156Z-14|3043|494Z-499|3206|728Z-356|6896|304Z496|1021|270Z-37|1548|85Z-301|3169|266Z-86|7308|286Z494|6741|305Z163|3469|506Z-299|900|498Z-81|736|412Z-197|6720|263Z-96|1246|525Z68|-291|317Z-454|396|561Z-364|1811|594Z324|1433|350Z-472|6960|646Z166|6404|563Z376|1061|772Z-281|701|532Z119|7168|578Z194|4071|471Z329|-428|379Z287|4487|71Z-139|358|676Z45|2821|285Z-25|359|358Z368|5532|250Z489|1283|693Z-438|7268|484Z-147|697|315Z401|1200|373Z154|2337|367Z-57|695|760Z299|3166|507Z488|88|233Z-425|7081|698Z-468|3904|542Z5|2958|555Z-360|4999|132Z63|6504|322Z242|1266|85Z-406|5611|403Z-251|316|684Z-316|2081|577Z120|4679|749Z-248|-27|258Z456|2224|353Z431|6597|649Z145|1553|242Z238|1667|435Z-310|276|312Z216|358|291Z-31|5972|436Z-97|782|57Z65|1319|783Z87|5927|700Z82|551|245Z164|7776|406Z146|5201|636Z-59|2802|700Z-462|5733|200Z-90|2335|118Z250|4086|747Z-16|2158|577Z416|398|578Z122|1262|782Z318|7533|767Z-206|6052|213Z81|1155|325Z-388|5212|490Z91|717|246Z-118|5924|666Z-127|973|355Z243|2181|586Z295|1702|230Z170|6280|8Z-68|571|127Z132|3696|4Z497|7214|740Z179|6130|645Z-241|-187|19Z410|1668|464Z-271|2048|466Z-169|3937|620Z210|4090|672Z251|3242|627Z-257|6682|678Z274|175|793Z305|814|39Z142|5412|465Z-305|3353|31Z245|1908|32Z-324|3553|354Z150|7268|708Z69|7139|201Z-471|6321|673Z-118|387|443Z15|6332|796Z362|3021|52Z314|3276|375Z201|7947|304Z-488|7010|733Z-407|4136|603Z324|5683|297Z445|1603|786Z278|2203|398Z35|4270|624Z-207|3545|586Z-188|-415|451Z227|4030|643Z193|5474|503Z-296|2917|500Z362|2556|114Z-237|4952|412Z-198|7168|245Z333|1384|448Z279|4817|549Z-277|2165|135Z491|3952|60Z445|5600|296Z270|3721|648Z291|38|458Z362|6056|614Z483|7975|690Z113|2668|430Z10|1462|64Z211|7269|302Z-403|6304|219Z0|0|0X24|5142|483Z417|1910|575Z10|-39|227Z-184|3979|466Z-42|-138|515Z117|7673|271Z36|1363|508Z51|1487|524Z61|1342|151Z-225|6595|650Z-138|2041|631Z80|6608|551Z-77|747|268Z111|4374|748Z-210|1867|571Z-66|686|25Z-234|1993|94Z-414|1057|794Z-421|-220|336Z233|2563|246Z-90|6178|283Z477|6026|21Z26|6724|490Z-150|1088|474Z-31|3117|632Z51|4245|716Z170|1805|47Z485|7040|368Z22|1119|524Z-209|6886|416Z-324|4277|421Z-172|5716|660Z360|7315|113Z36|3184|783Z205|7937|232Z32|461|295Z-481|2610|271Z244|3620|613Z-429|1687|706Z-92|128|678Z132|945|177Z-298|1869|606Z185|-475|87Z453|1511|400Z283|7988|676Z-432|-4|622Z207|2869|110Z-250|6268|163Z357|7093|697Z346|3036|67Z0|0|0";
			//var Seed = "";
			
			var Plane;
			
			init();
			animate();
			
			//-----------------MOUSE CONTROLS----------------------\\
			var canvas = document.querySelector('canvas');
			// pointer lock object forking for cross browser
			canvas.requestPointerLock = canvas.requestPointerLock ||
										canvas.mozRequestPointerLock;

			document.exitPointerLock = document.exitPointerLock ||
									   document.mozExitPointerLock;

			canvas.onclick = function() {
			  canvas.requestPointerLock();
			};

			// Hook pointer lock state change events for different browsers
			document.addEventListener('pointerlockchange', lockChangeAlert, false);
			document.addEventListener('mozpointerlockchange', lockChangeAlert, false);
			
			document.oncontextmenu = function() 
			{
				return false;
			}

			var mouseEnabled = false;
			var Sensitivity = 900;
			var NormSensitivity = 900;
			var ZoomSensitivity = 1500;
			var invertedX = false;
			
			function lockChangeAlert() {
			  if (document.pointerLockElement === canvas ||
				  document.mozPointerLockElement === canvas) {
				console.log('The pointer lock status is now locked');
				mouseEnabled = true;
				window.addEventListener('mousemove',updateMovement, false);
			  } else {
				console.log('The pointer lock status is now unlocked');  
				mouseEnabled = false;
				window.removeEventListener('mousemove',updateMovement, false);
			  }
			}
			
			function updateMovement(event) //Move camera with Mouse
			{
				if (mouseEnabled == true)
				{
					var mouseX = Math.floor(event.movementX); 
					var mouseY = Math.floor(event.movementY);
					
					if (invertedX == false)
					{
						var offsetX = -(mouseX)/Sensitivity;
					}
					else if (invertedX == true)
					{
						var offsetX = (mouseX)/Sensitivity;
					}
					
					var offsetY = -(mouseY)/Sensitivity;
					Player.RigidBody.AngleY += offsetX;
					Player.RigidBody.AngleX += offsetY;
				}
			}
			//----------------END OF MOUSE CONTROLS----------------------\\
			
			function init() 
			{
				Settings = new SettingsObject(); //Generate new set of settings
				Player = new PlayerObject(); //Add Player
				scene = new THREE.Scene(); //Create Scene
				
				//Create mouse click
				var canvas = document.getElementById("main_window");
				
				canvas.addEventListener("mousedown", function (event) {
					if (event.which == 3)
					{
						Player.FOV = Player.Zoom;
						Sensitivity = ZoomSensitivity;
					}
					if (event.which == 1)
					{
						Player.click = true;
					}
				});
				
				canvas.addEventListener("mouseup", function (event) {
					if (event.which == 3)
					{
						Player.FOV = Player.FOVValue;
						Sensitivity = NormSensitivity;
					}
					if (event.which == 1)
					{
						Player.click = false;
					}
				});
				
				//create begin and end floor
				var Floor1 = new FloorObject(0,0,0,Settings.GroundWidth, Settings.GroundHeight);
				Floor.push(Floor1);
				
				scene.add( Floor[0].Plane ); //Add floor to Scene
				
				var Floor2 = new FloorObject(0,0,8000,Settings.GroundWidth, Settings.GroundHeight);
				Floor.push(Floor2);
				
				scene.add( Floor[1].Plane ); //Add second floor to Scene
				
				if (Seed.length > 0) //Convert Seed Data to Blocks
				{
					var stringValue = Seed.split("X"); //Seperate the small blocks and large blocks
					console.log(stringValue);
					for (var q=0; q<stringValue.length; q++)
					{
						var stringValue2 = stringValue[q].split("Z") //Seperate the individual blocks
						for (var i = 0; i<stringValue2.length ;i++)
						{
							var stringValue3 = stringValue2[i].split("|"); //Seperate the Data for each block
							if (q == 0)
							{
								createBlocks(parseInt(stringValue3[0]), parseInt(stringValue3[1]), parseInt(stringValue3[2])); //Input Data from each Data string	
							}
							else if (q == 1)
							{
								createSmallBlocks(parseInt(stringValue3[0]), parseInt(stringValue3[1]), parseInt(stringValue3[2]), 0, 0, 0);
							}
						}
					}
					
					for (var i = 0; i < numDrones; i++)
					{
						x = Math.floor(Math.random() * (500 - -500) + -500);
						z = Math.floor(Math.random() * (8000 - 500) + 500);
						y = Math.floor(Math.random() * (500 - 1) + 1);
						d = Math.floor(Math.random() * (500 - 1) + 1);
						a = Math.floor(Math.random() * (1200 - 400) + 400);
						
						createDrone(x,y,z,d,a);
					}
				}
				else
				{
					for (var i = 0; i<230 ;i++) //Create 230 random blocks
					{
						x = Math.floor(Math.random() * (500 - -500) + -500);
						y = Math.floor(Math.random() * (8000 - -500) + -500);
						z = Math.floor(Math.random() * (800 - 1) + 1);
						Seed += x.toString() + "|" + y.toString() + "|" + z.toString() + "Z"; //Create Seed Data
						createBlocks(x, y, z);
					}
					Seed += "0|0|0X"; //Add break point
					for (var i = 0; i<50 ;i++) //50
					{
						x = Math.floor(Math.random() * (500 - -500) + -500);
						y = Math.floor(Math.random() * (8000 - -500) + -500);
						z = Math.floor(Math.random() * (800 - 1) + 1);
						Seed += x.toString() + "|" + y.toString() + "|" + z.toString() + "Z"; //create seed data
						createSmallBlocks(x, y, z, 0, 0, 0);
					}
					Seed += "0|0|0"; //end
					console.log(Seed); //Show seed
					createBlocks(0,0,30);
					
					for (var i = 0; i < numDrones; i++)
					{
						x = Math.floor(Math.random() * (500 - -500) + -500);
						z = Math.floor(Math.random() * (8000 - 500) + 500);
						y = Math.floor(Math.random() * (500 - 1) + 1);
						d = Math.floor(Math.random() * (500 - 1) + 1);
						a = Math.floor(Math.random() * (1200 - 400) + 400);
						
						createDrone(x,y,z,d,a);
					}
				}
				
				renderer = new THREE.WebGLRenderer(); //Create Renderer
				renderer.setPixelRatio( window.devicePixelRatio );
				renderer.setSize( window.innerWidth, window.innerHeight );
				document.body.appendChild( renderer.domElement ); //Add Renderer
				
				window.addEventListener( 'resize', onWindowResize, false );
			}

			function onWindowResize() 
			{
				Player.Camera.aspect = window.innerWidth / window.innerHeight;
				Player.Camera.updateProjectionMatrix();
				renderer.setSize( window.innerWidth, window.innerHeight );
			}
			
			function animate() 
			{
				requestAnimationFrame( animate ); //create animation timer
				
				//updates to objects and things go here:
				updateBlocks();
				updateBullets();
				updateDrones();
				Player.update();
				CheckRigidBodies();
				
				for (var i = 0;i<Floor.length;i++)
				{
					var half = 90*(Math.PI/180);
					Floor[i].Plane.rotation.x = half;
				}
				
				//render everything
				renderer.render( scene, Player.Camera );
			}
			
			function updateBlocks()
			{
				for (var i=0;i<Blocks.length;i++)
				{
					Blocks[i].update();
				}
				
				for (var i = 0; i<SmallBlocks.length; i++)
				{
					SmallBlocks[i].update();
				}
			}
			
			function updateDrones()
			{
				for (var i = 0; i<Drones.length; i++)
				{
					Drones[i].update();
					if (Drones[i].Hp <= 0)
					{
						RemoveObject(Drones[i]);
						Drones.splice(i, 1);
					}
					if (Drones[i].RigidBody.Collided == true && Drones[i].RigidBody.CollidedWith.ObjectType == "Player")
					{
						Player.RigidBody.VelocityX = Math.floor(Math.random() * (50 - -50) + -50);
						Player.RigidBody.VelocityY = Math.floor(Math.random() * (20 - -20) + -20);
						Player.RigidBody.VelocityZ = Math.floor(Math.random() * (50 - -50) + -50);
					}
				}
			}
			
			function updateBullets()
			{
				for (var i = 0; i<Bullets.length;i++)
				{
					Bullets[i].update();
					if (Bullets[i].RigidBody.Collided == true && Bullets[i].RigidBody.CollidedWith.ObjectType == "Floor")
					{
						RemoveObject(Bullets[i]);
						Bullets.splice(i, 1);
					}
					else if  (Bullets[i].Destroyed == true)
					{
						RemoveObject(Bullets[i]);
						Bullets.splice(i, 1);
					}
					else if (Bullets[i].CurrentLifeSpan >= Bullets[i].LifeSpan)
					{
						RemoveObject(Bullets[i]);
						Bullets.splice(i, 1);
					}
				}
			}
			
			function RemoveObject(object)
			{
				object.Mesh.material.dispose();
				object.Mesh.geometry.dispose();
				scene.remove(object.Mesh);
			}
		</script>
	</body>
</html>